#!/usr/bin/env bash
set -euo pipefail

script_source="${BASH_SOURCE[0]}"
if command -v readlink >/dev/null 2>&1; then
  resolved="$(readlink -f "$script_source" 2>/dev/null || true)"
  if [[ -n "$resolved" ]]; then
    script_source="$resolved"
  fi
elif command -v realpath >/dev/null 2>&1; then
  resolved="$(realpath "$script_source" 2>/dev/null || true)"
  if [[ -n "$resolved" ]]; then
    script_source="$resolved"
  fi
fi

repo_root="$(cd "$(dirname "$script_source")" && pwd)"

ui_mode="tauri" # tauri

free_vite_port_if_needed() {
  local port=1420

  if ! command -v lsof >/dev/null 2>&1; then
    return 0
  fi

  local pids
  pids="$(lsof -tiTCP:"$port" -sTCP:LISTEN 2>/dev/null || true)"
  if [[ -z "$pids" ]]; then
    return 0
  fi

  local pid
  for pid in $pids; do
    local args
    args="$(ps -p "$pid" -o args= 2>/dev/null || true)"
    if [[ "$args" == *vite* ]] || [[ "$args" == *"node"*"vite"* ]]; then
      echo "ReOS: Port $port in use by prior dev server (pid $pid); stopping it…" >&2
      kill "$pid" 2>/dev/null || true
    fi
  done
}

can_launch_tauri() {
  local tauri_dir="$repo_root/apps/reos-tauri"

  if [[ -z "${DISPLAY:-}" && -z "${WAYLAND_DISPLAY:-}" ]]; then
    return 1
  fi

  if [[ ! -d "$tauri_dir" ]]; then
    return 1
  fi

  if ! command -v npm >/dev/null 2>&1; then
    return 1
  fi

  if [[ -f "$HOME/.cargo/env" ]]; then
    # shellcheck disable=SC1091
    source "$HOME/.cargo/env"
  fi

  if ! command -v cargo >/dev/null 2>&1; then
    return 1
  fi

  if ! command -v rustc >/dev/null 2>&1; then
    return 1
  fi

  if ! command -v pkg-config >/dev/null 2>&1; then
    return 1
  fi

  if ! pkg-config --exists glib-2.0 gio-2.0 >/dev/null 2>&1; then
    return 1
  fi
  if ! pkg-config --exists webkit2gtk-4.1 >/dev/null 2>&1 && ! pkg-config --exists webkit2gtk-4.0 >/dev/null 2>&1; then
    return 1
  fi

  return 0
}

python_bin="$repo_root/.venv/bin/python"
if [[ ! -x "$python_bin" ]]; then
  echo "ReOS: missing venv interpreter at $python_bin" >&2
  echo "Create it with: python3.12 -m venv .venv && .venv/bin/python -m pip install -e ." >&2
  exit 1
fi

# Default: start GUI. Use `--service` to start the FastAPI service.
mode="gui"
if [[ "${1:-}" == "--service" ]]; then
  mode="service"
  shift
fi

if [[ "${1:-}" == "--mcp" ]]; then
  mode="mcp"
  shift
fi

if [[ "${1:-}" == "--ui" ]]; then
  ui_mode="${2:-}"
  shift 2
fi

if [[ "${1:-}" == "--tauri" ]]; then
  ui_mode="tauri"
  shift
fi

if [[ "${1:-}" == "--pyside" ]]; then
  echo "ReOS: PySide6 GUI has been retired. Use: ./reos --ui tauri" >&2
  exit 2
fi

if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
  cat <<'EOF'
Usage:
  ./reos                       # launch TypeScript/Tauri UI (dev)
  ./reos --ui tauri            # launch TypeScript/Tauri UI (dev)
  ./reos --service             # launch ReOS local service (FastAPI)
  ./reos --mcp                 # launch ReOS MCP server (stdio)

Aliases:
  ./reos --tauri

Notes:
  - Set REOS_REPO_PATH=/path/to/repo to choose which repo to observe.
  - Set REOS_LOG_LEVEL=DEBUG for more verbose logs.
EOF
  exit 0
fi

if [[ "$mode" == "gui" ]]; then
  if [[ -z "${DISPLAY:-}" && -z "${WAYLAND_DISPLAY:-}" ]]; then
    echo "ReOS: no GUI display detected (DISPLAY/WAYLAND_DISPLAY is empty)." >&2
    echo "Run the service instead: ./reos --service" >&2
    exit 2
  fi

  if [[ "$ui_mode" != "tauri" ]]; then
    echo "ReOS: unsupported UI mode '$ui_mode'. Supported: tauri" >&2
    exit 2
  fi

  if ! can_launch_tauri; then
    echo "ReOS: cannot launch Tauri UI (missing prerequisites)." >&2
    echo "Required: npm + Rust toolchain + pkg-config + webkit2gtk, plus apps/reos-tauri." >&2
    echo "On Ubuntu/Debian, run: $repo_root/install-tauri-deps.sh" >&2
    exit 4
  fi

  "$repo_root/scripts/bootstrap.sh" >/dev/null
  free_vite_port_if_needed

  echo "ReOS: launching TypeScript/Tauri UI (dev)…" >&2
  cd "$repo_root/apps/reos-tauri"
  exec npm run tauri:dev
elif [[ "$mode" == "mcp" ]]; then
  exec "$python_bin" -m reos.mcp "$@"
else
  exec "$python_bin" -m reos "$@"
fi
